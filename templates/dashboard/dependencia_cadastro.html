{% extends 'base.html' %}
{% load static %}

{% block title %}Cadastrar Depend√™ncia de Impacto{% endblock %}

{% block content %}

<div class="container mt-5">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            
            <!-- CABE√áALHO -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>üìù Cadastrar Depend√™ncia</h2>
                <a href="{% url 'dependencias' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>

            <!-- MENSAGENS DE ERRO/SUCESSO -->
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}

            <!-- FORMUL√ÅRIO -->
            <form method="POST" class="needs-validation" id="formDependencia">
                {% csrf_token %}

                <!-- ============================================================================
                     CARD 1: ITEM PRINCIPAL (SER AFETADO)
                     ============================================================================ -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            üéØ Selecione o Item PRINCIPAL
                        </h5>
                        <small class="text-white-50">
                            Este √© o item que SER√Å AFETADO se alterado
                        </small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <label for="principal_tipo" class="form-label">
                                    <strong>Tipo Principal:</strong>
                                </label>
                                <select 
                                    name="principal_tipo" 
                                    id="principal_tipo" 
                                    class="form-select" 
                                    required
                                    onchange="atualizarPrincipal()">
                                    <option value="">-- Selecione um tipo --</option>
                                    <option value="sql">SQL (Senten√ßa)</option>
                                    <option value="report">REPORT (Relat√≥rio)</option>
                                    <option value="fv">F√ìRMULA (FV)</option>
                                </select>
                                <small class="text-muted d-block mt-2">
                                    Escolha o tipo do item principal
                                </small>
                            </div>
                            <div class="col-md-8">
                                <label for="principal_id" class="form-label">
                                    <strong>ID do Item:</strong>
                                </label>
                                <select 
                                    name="principal_id" 
                                    id="principal_id" 
                                    class="form-select" 
                                    required
                                    disabled>
                                    <option value="">-- Selecione um item --</option>
                                </select>
                                <small class="text-muted d-block mt-2">
                                    Primeiro selecione o tipo
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================================================================
                     CARD 2: ITENS DEPENDENTES (M√öLTIPLOS)
                     ============================================================================ -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            üîó Selecione os Itens DEPENDENTES
                        </h5>
                        <small class="text-white-50">
                            Selecione 1 ou mais itens que dependem do principal
                        </small>
                    </div>
                    <div class="card-body">
                        
                        <!-- SQL -->
                        <div class="mb-5">
                            <h6 class="border-bottom pb-2">
                                <span class="badge bg-primary">SQL</span> Senten√ßas
                            </h6>
                            <div class="list-group mt-3" style="max-height: 300px; overflow-y: auto;">
                                {% for sql in sqls %}
                                    <label class="list-group-item">
                                        <input 
                                            type="checkbox" 
                                            name="dependencia_sql[]" 
                                            value="{{ sql.codsentenca }}"
                                            class="form-check-input me-2">
                                        <strong>{{ sql.codsentenca }}</strong><br>
                                        <small class="text-muted">{{ sql.titulo }}</small>
                                    </label>
                                {% empty %}
                                    <div class="alert alert-warning mb-0">
                                        Nenhuma SQL cadastrada
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- REPORT -->
                        <div class="mb-5">
                            <h6 class="border-bottom pb-2">
                                <span class="badge bg-warning">REPORT</span> Relat√≥rios
                            </h6>
                            <div class="list-group mt-3" style="max-height: 300px; overflow-y: auto;">
                                {% for report in reports %}
                                    <label class="list-group-item">
                                        <input 
                                            type="checkbox" 
                                            name="dependencia_report[]" 
                                            value="{{ report.id }}"
                                            class="form-check-input me-2">
                                        <strong>REP {{ report.id }}</strong><br>
                                        <small class="text-muted">{{ report.codigo }}</small>
                                    </label>
                                {% empty %}
                                    <div class="alert alert-warning mb-0">
                                        Nenhum Report cadastrado
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- F√ìRMULA -->
                        <div class="mb-5">
                            <h6 class="border-bottom pb-2">
                                <span class="badge bg-info">F√ìRMULA</span> F√≥rmulas/Vis√µes
                            </h6>
                            <div class="list-group mt-3" style="max-height: 300px; overflow-y: auto;">
                                {% for fv in fvs %}
                                    <label class="list-group-item">
                                        <input 
                                            type="checkbox" 
                                            name="dependencia_fv[]" 
                                            value="{{ fv.id }}"
                                            class="form-check-input me-2">
                                        <strong>FV {{ fv.id }}</strong><br>
                                        <small class="text-muted">{{ fv.nome }}</small>
                                    </label>
                                {% empty %}
                                    <div class="alert alert-warning mb-0">
                                        Nenhuma F√≥rmula cadastrada
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> 
                            <strong>Dica:</strong> Selecione pelo menos 1 dependente para salvar
                        </div>
                    </div>
                </div>

                <!-- ============================================================================
                     CARD 3: PRIORIDADE
                     ============================================================================ -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">‚ö†Ô∏è N√≠vel de Prioridade</h5>
                    </div>
                    <div class="card-body">
                        <label for="id_prioridade" class="form-label">
                            <strong>Qual o n√≠vel de impacto?</strong>
                        </label>
                        <select 
                            name="id_prioridade" 
                            id="id_prioridade" 
                            class="form-select">
                            <option value="">-- Sem Prioridade --</option>
                            {% for prioridade in prioridades %}
                                <option value="{{ prioridade.id }}">
                                    {{ prioridade.nivel }}
                                </option>
                            {% endfor %}
                        </select>
                        <small class="text-muted d-block mt-2">
                            Indica a import√¢ncia da depend√™ncia
                        </small>
                    </div>
                </div>

                <!-- ============================================================================
                     BOT√ïES DE A√á√ÉO
                     ============================================================================ -->
                <div class="d-flex gap-2 mb-5">
                    <button type="submit" class="btn btn-success btn-lg">
                        <i class="fas fa-save"></i> Salvar Depend√™ncia
                    </button>
                    <a href="{% url 'dependencias' %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times"></i> Cancelar
                    </a>
                </div>

            </form>

        </div>
    </div>
</div>

<!-- SCRIPT JAVASCRIPT -->
<script>
// Dados dos itens (passados do Django)
const sqls = {{ sqls|safe }};
const reports = {{ reports|safe }};
const fvs = {{ fvs|safe }};

// Fun√ß√£o para atualizar o seletor de ID baseado no tipo selecionado
function atualizarPrincipal() {
    const tipo = document.getElementById('principal_tipo').value;
    const selectId = document.getElementById('principal_id');
    
    // Limpa todas as op√ß√µes
    selectId.innerHTML = '<option value="">-- Selecione um item --</option>';
    
    // Desabilita se n√£o houver tipo selecionado
    if (!tipo) {
        selectId.disabled = true;
        return;
    }
    
    selectId.disabled = false;
    
    // Preenche baseado no tipo
    let items = [];
    if (tipo === 'sql') {
        items = sqls;
    } else if (tipo === 'report') {
        items = reports;
    } else if (tipo === 'fv') {
        items = fvs;
    }
    
    // Adiciona op√ß√µes
    items.forEach(item => {
        const option = document.createElement('option');
        if (tipo === 'sql') {
            option.value = item.codsentenca;
            option.textContent = `${item.codsentenca} - ${item.titulo}`;
        } else if (tipo === 'report') {
            option.value = item.id;
            option.textContent = `${item.id} - ${item.codigo}`;
        } else if (tipo === 'fv') {
            option.value = item.id;
            option.textContent = `${item.id} - ${item.nome}`;
        }
        selectId.appendChild(option);
    });
}

// Valida√ß√£o do formul√°rio
document.getElementById('formDependencia').addEventListener('submit', function(e) {
    // Valida principal
    const principalTipo = document.getElementById('principal_tipo').value;
    const principalId = document.getElementById('principal_id').value;
    
    if (!principalTipo || !principalId) {
        e.preventDefault();
        alert('‚ùå Selecione um item principal!');
        return;
    }
    
    // Valida dependentes
    const checkboxes = document.querySelectorAll(
        'input[name^="dependencia_"][type="checkbox"]:checked'
    );
    
    if (checkboxes.length === 0) {
        e.preventDefault();
        alert('‚ùå Selecione pelo menos 1 dependente!');
        return;
    }
});
</script>

{% endblock %}
